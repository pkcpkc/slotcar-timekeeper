<html>

<head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
</head>
<style>
    canvas {
        width: 100%;
        height: 33%;
    }
    video {
        width: 100%;
        height: 33%;
    }
</style>

<body>
    <video id="video" autoplay playsinline></video><br />
    <canvas id="canvas"></canvas><br />
    <input type="button" id="reset" value="Reset" onclick="reset();" /><br />
    <div id="log"></div>
    <script>
        let context = document.getElementById("canvas").getContext('2d', { 'willReadFrequently': true });
        let video = document.getElementById("video");
        let log = document.getElementById("log");

        let width = video.width;
        let height = video.height;
        let splitWidth = width / 5;
        let splitHeight = height / 4;
        let blockSize = 5;
        let rectLeft = { x: splitWidth, y: splitHeight, width: splitWidth, height: height - splitHeight * 2 };
        let rectRight = { x: splitWidth * 3, y: splitHeight, width: splitWidth, height: height - splitHeight * 2 };

        var defaultColorLeft = [0, 0, 0];
        var leftActive = false;
        var countLeft = 0;
        var defaultColorRight = [0, 0, 0];
        var rightActive = false;
        var countRight = 0;
        var colorThreshold = 40;

        (async () => {
            video.srcObject = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: {
                    facingMode: 'environment',
                    width: width,
                    height: height
                }
            });
            video.requestVideoFrameCallback(screenshot);
        })();

        function getCSSColor(rgbArray) {
            return `rgb(${rgbArray[0]},${rgbArray[1]},${rgbArray[2]})`;
        }

        function getAverageRGBBlock(imageData, blockSize) {
            const RGBA_ARRAY_LENGTH = 4;
            let length = imageData.data.length;
            let data = imageData.data;
            var count = 0;
            var rgb = [0, 0, 0];
            for (var i = 0; i < length; i += blockSize * RGBA_ARRAY_LENGTH) {
                count++;
                rgb[0] += data[i];
                rgb[1] += data[i + 1];
                rgb[2] += data[i + 2];
            }
            rgb[0] = ~~(rgb[0] / count);
            rgb[1] = ~~(rgb[1] / count);
            rgb[2] = ~~(rgb[2] / count);
            return rgb;
        }

        function getColorLeft() {
            return getAverageRGBBlock(context.getImageData(rectLeft.x, rectLeft.y, rectLeft.width, rectLeft.height), blockSize);
        }

        function getColorRight() {
            return getAverageRGBBlock(context.getImageData(rectRight.x, rectRight.y, rectRight.width, rectRight.height), blockSize);
        }

        function screenshot() {
            context.drawImage(video, rectLeft.x, rectLeft.y, rectLeft.width, rectLeft.height, rectLeft.x, rectLeft.y, rectLeft.width, rectLeft.height);
            context.drawImage(video, rectRight.x, rectRight.y, rectRight.width, rectRight.height, rectRight.x, rectRight.y, rectRight.width, rectRight.height);

            let colorLeft = getColorLeft();
            let colorRight = getColorRight();

            let diffLeft = calculateDiff(defaultColorLeft, colorLeft);
            if (diffLeft > colorThreshold && !leftActive) {
                leftActive = true;
                countLeft++;
                log.innerHTML = `${countLeft} | ${countRight}`;
            } else if (diffLeft <= colorThreshold) {
                leftActive = false;
            }

            let diffRight = calculateDiff(defaultColorRight, colorRight);
            if (diffRight > colorThreshold && !rightActive) {
                rightActive = true;
                countRight++;
                log.innerHTML = `${countLeft} | ${countRight}`;
            } else if (diffRight <= colorThreshold) {
                rightActive = false;
            }

            context.fillStyle = getCSSColor(colorLeft);
            context.fillRect(rectLeft.x, rectLeft.y, rectLeft.width, rectLeft.height);
            context.fillStyle = getCSSColor(colorRight);
            context.fillRect(rectRight.x, rectRight.y, rectRight.width, rectRight.height);

            video.requestVideoFrameCallback(screenshot);
        }

        function reset() {
            defaultColorLeft = getColorLeft();
            defaultColorRight = getColorRight();
            log.innerHTML = '';
        }

        function calculateDiff(colorDefault, colorCurrent) {
            var diff = 0;
            for (var i = 0; i < colorDefault.length; i++) {
                diff += Math.abs(colorDefault[i] - colorCurrent[i]);
            }
            return diff;
        }
    </script>
</body>

</html>
